name: Build and Deploy Afghankar.com to Azure Static Website

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  AZURE_STORAGE_ACCOUNT_NAME: angursweb01

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Copy SEO and config files
        run: |
          echo "Copying SEO and config files..."
          cp ./public/robots.txt ./dist/robots.txt
          cp ./public/sitemap.xml ./dist/sitemap.xml
          cp ./public/404.html ./dist/404.html
          cp ./public/staticwebapp.config.json ./dist/staticwebapp.config.json
          cp ./public/web.config ./dist/web.config
          cp ./public/_redirects ./dist/_redirects
          [ -f "./staticwebapp.config.json" ] && cp ./staticwebapp.config.json ./dist/staticwebapp.config.json
          echo "Files copied successfully!"

      - name: Azure Login via Service Principal
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Static Website ($web)
        uses: azure/cli@v1
        with:
          inlineScript: |
            echo "Deploying files to Azure Storage static website..."
            
            # Upload all files
            az storage blob upload-batch \
              --account-name ${{ env.AZURE_STORAGE_ACCOUNT_NAME }} \
              --destination '$web' \
              --source ./dist \
              --auth-mode login \
              --overwrite true

            # Individually ensure SEO files and configs have correct content-type
            for file in robots.txt sitemap.xml 404.html staticwebapp.config.json web.config _redirects; do
              if [ -f "./dist/$file" ]; then
                contentType="application/octet-stream"
                case $file in
                  *.txt) contentType="text/plain";;
                  *.xml) contentType="application/xml";;
                  *.html) contentType="text/html";;
                  *.json) contentType="application/json";;
                  *.config) contentType="application/xml";;
                esac
                echo "Uploading $file with content-type $contentType..."
                az storage blob upload \
                  --account-name ${{ env.AZURE_STORAGE_ACCOUNT_NAME }} \
                  --container-name '$web' \
                  --name $file \
                  --file ./dist/$file \
                  --content-type $contentType \
                  --auth-mode login \
                  --overwrite
              fi
            done

            echo "Verifying deployed files..."
            az storage blob list \
              --account-name ${{ env.AZURE_STORAGE_ACCOUNT_NAME }} \
              --container-name '$web' \
              --auth-mode login \
              --query '[].{Name:name, ContentType:properties.contentSettings.contentType}' \
              --output table
